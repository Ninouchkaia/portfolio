#!/usr/bin/python
# -*- coding: utf-8 -*-

# this script reads a fasta file of proteins and counts the amino acid occurences in each protein.
# it creates different files that serve to make a final file containing the uniprot id names of the proteins, their abundance (cf. pax-db databse), and the counts of amino acids for each protein.
# it has to be executed where the final files will be saved

import timeit
start = timeit.default_timer()
import os
import sys
import re
from Bio import SeqIO # to parse the fasta file
from Bio import SeqUtils # Miscellaneous functions for dealing with sequences.
from Bio.SeqUtils import  ProtParam

## we start by creating a list of uniprot ids that were mapped to string ids
handle_mapping_table = open("/home/nina/scripts/paxdb/abundance_datasets/mapping_tables/%s_uniprot.txt" % sys.argv[1], "rU")
read_mapping_table = handle_mapping_table.readlines()
handle_fasta = open("/home/nina/scripts/paxdb/abundance_datasets/fasta/%s.fasta" % sys.argv[1], "rU") #opens the fasta file containing the sequences
handle_dataset = open("/home/nina/scripts/paxdb/abundance_datasets/datasets/%s_dataset.txt" % sys.argv[1], "rU")
read_dataset = handle_dataset.readlines()	
abundance_list = []
for record in SeqIO.parse(handle_fasta, "fasta") : # for each uniprot in the fasta file : (for another obscur reason, the 2 for loops have to go in this order)
	for mapping in read_mapping_table :
		mapping = mapping.replace('\n', '') # remove '\n' only
		mapping = mapping.split("\t")
		if record.id[3:9] == mapping[1] :
			for abundance_data in read_dataset :
				abundance_data = abundance_data.split("\t")
				print abundance_data[1]
				#if mapping[0] == abundance_data[1]:
					#abundance_list.append("%s\t%s\t%s" % (mapping[1], abundance_data[1], abundance_data[2]))
handle_mapping_table.close()				  
handle_fasta.close()
handle_dataset.close()

file_write1 = open("%s_1.txt" % sys.argv[1],'w+') # will print the list of proteins in a column
file_write2 = open("%s_2.txt" % sys.argv[1],'a+') # will print the counts of each amino acid as a table
file_write3 = open("%s_3.txt" % sys.argv[1],'w+') # will print the keys of the dict (the amino acids)
file_write4 = open("%s_4.txt" % sys.argv[1],'w+') # will print the abundance values for each protein as a column 
# for this we need to substract all the proteins from the dataset taken from pax-db, that were not mapped through uniprot ID mapping.
# or create a loop that will print only the abundance values for the protein IDs that match with the uniprot list.

#handle_fasta = open("/home/nina/scripts/paxdb/abundance_datasets/fasta/%s.fasta" % sys.argv[1], "rU")  #for an obscur reason, handle_fasta had to be closed and reopened...
#for record in SeqIO.parse(handle_fasta, "fasta"):
	
	#my_seq = record.seq #get each sequence as a string
	#X = ProtParam.ProteinAnalysis("%s" % my_seq)  # creates the variable containing the sequence, to be passed in the count_amino_acids function.
	#dict_seq = X.count_amino_acids() # will count frequency of amino acid in each sequence and return as a dict
	#file_write1.write("%s\n" % record.id ) # will print the list of proteins in a column
	##print record
	
	#for key in dict_seq :
		#file_write2.write("%s\t" % dict_seq[key]) # will print the counts of each amino acid of each protein as a table
	#file_write2.write("\n") # goes to next line when done for one protein # file2 needs to be rewritable a+
	
	#for i in range(0, len(abundance_list)) :
		#if record.id[3:9] == abundance_list[i][0:6] :
			#abundance_list[i] = abundance_list[i].split("\t")
			#print "%s\t%s" % (abundance_list[i][0], abundance_list[i][2])
			#file_write4.write("%s\t%s\t%s" % (abundance_list[i][0], abundance_list[i][1], abundance_list[i][2]))
		
#handle_fasta.close()

#file_write3.write("abundance\t")
#for key in dict_seq :
	#file_write3.write("%s\t" % (key))

file_write1.close()
file_write2.close()
file_write3.close()
file_write4.close()

#file_write3.write("%s\t%s\n" % (record.id, X.count_amino_acids()))

stop = timeit.default_timer()
print stop - start 